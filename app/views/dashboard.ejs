<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard</title>
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/sweetalert2@7.12.15/dist/sweetalert2.min.css'>
  </link>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

</head>

<style>
  .main {
    margin: 10px;
    padding: 20px;
    background-color: antiquewhite;
  }

  .main section {
    margin-top: 10px;
    padding: 20px;
  }

  .main section:nth-child(1) {
    background-color: rgb(209, 178, 238);
  }

  .main section:nth-child(2) {
    background-color: rgb(148, 245, 245);
  }
</style>

<body>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@7.12.15/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.15/jquery.mask.min.js"></script>
  <%- include('partials/navbar') %>

    <div class="main">

      <section class="rounded-5">
        <h1 id="userCounts"></h1>
        <div class="container">
          <h1 class="text-center text-capitalize pt-5">Services</h1>
          <hr class="w-25 mx-auto pt-5">

          <div class="row text-center mb-5">
            <div class="col-lg-4 col-md-4 col-12">
              <div class="card">
                <img class="card-img-top img-fluid" src="/images/7.jpg" class="image-fluid" alt="Card image">
                <div class="card-body">
                  <h4 class="card-title">Prescriptions</h4>
                  <p class="card-text">Medicine Available Here</p>
                  <a href="#" class="btn btn-primary">See More</a>
                </div>
              </div>
            </div>

            <div class="col-lg-4 col-md-4 col-12">
              <div class="card">
                <img class="card-img-top img-fluid" src="/images/8.jpg" class="image-fluid" alt="Card image">
                <div class="card-body">
                  <h4 class="card-title">Dr. Emma Watson</h4>
                  <p class="card-text">Physician</p>
                  <a href="#" class="btn btn-primary">See Profile</a>
                </div>
              </div>
            </div>

            <div class="col-lg-4 col-md-4 col-12">
              <div class="card">
                <img class="card-img-top img-fluid" src="/images/9.jpg" class="image-fluid" alt="Card image">
                <div class="card-body">
                  <h4 class="card-title">Prevention</h4>
                  <p class="card-text">Searching..... specific medicine</p>
                  <a href="#" class="btn btn-primary">See More</a>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>


      <section class="mt-2 rounded-5">
        <div class="container">
          <h1 class="text-center text-capitalize pt-5">UPDATE AND VIEW DETAILS</h1>
          <hr class="w-25 mx-auto pt-5">

          <div class="row text-center mb-5">
            <div class="col-lg-6 col-md-6 col-12">
              <div class="card m-4">
                <h5 class="card-title my-2 py-3">Profile Details</h5>
                <div class="card-body">
                  <p class="card-title">You can Update your details</p>
                  <button class="btn btn-primary" data-bs-modal="modal" data-bs-target="#editDetails"
                    id="updateDetails">Click Here</button>
                </div>
              </div>
            </div>

            <div class="col-lg-6 col-md-6 col-12 mb-5">
              <div class="card m-4">
                <h5 class="card-title my-2 py-3">Vaccination Details</h5>
                <div class="card-body">
                  <p class="card-text">You can View Your Vaccination Details</p>
                  <a href="#" class="btn btn-primary" id="showDetailsButton" data-bs-modal="modal"
                    data-bs-target="#userDetailsModal"> See Details </a>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>



      <!-- Upload Image Section -->
      <section class="mt-2 rounded-5 ">
        <h1 class="text-center text-capitalize pt-5">Upload Images</h1>
        <hr class="w-25 mx-auto pt-5">
      
        <div class="row mb-5 d-flex justify-content-center align-content-center mx-2">
          <div class="col-12 col-md-3 px-3 border rounded-4 bg-body-tertiary">
            <div class="container-lg container-fluid">
              <form action="">
                <label for="uploadImg" class="form-label">Upload Image</label>
                <input type="file" id="uploadImg" class="form-control form-control-file" />
                <button type="submit" class="btn btn-success" id="uploadBtn">Submit</button>
              </form>
            </div>
          </div>
      
          <div class="col-12 col-md-8 px-3 border rounded-4 bg-body">
            <div class="row d-flex justify-content-center align-content-center mx-2">
              <div class="col-12 col-sm-6 p-2 ">
                <canvas id="uploadedImg">
                   
                </canvas>
              </div>
              <div class="col-12 col-sm-6 p-2">
                <canvas id="savedImg">
                   
                </canvas>
              </div>
            </div>
          </div>
        </div>
      </section>
      

      <!-- Edit Profile Details -->
      <div class="modal fade" id="editDetailsModal" tabindex="-1" aria-labelledby="editDetailsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-fullscreen modal-backdrop">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editDetailsModalLabel">Profile Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="main">
                <div class="main-container m-2 p-3 basic-details">
                  <h3 class="row g-3 p-2 m-3">DETAILS</h3>
                  <div id="edit Form" class="row g-3 p-2 m-2">
                    <div class="col-md-4">
                      <label for="firstName" class="form-label">First Name</label>
                      <input type="text" class="form-control" value="<%= user.first_name%>" id="firstName"
                        name="firstName" readonly>
                    </div>
                    <div class="col-md-4">
                      <label for="middleName" class="form-label">Middle Name</label>
                      <input type="text" class="form-control" value="<%= user.middle_name%>" id="middleName"
                        name="middleName" readonly>
                    </div>
                    <div class="col-md-4">
                      <label for="lastName" class="form-label">Last Name</label>
                      <input type="text" class="form-control" value="<%= user.last_name%>" id="lastName" name="lastName"
                        readonly>
                    </div>

                    <div class="col-md-7">
                      <label for="inputEmail" class="form-label ">Email</label>
                      <input type="email" class="form-control" value="<%= user.email%>" id="inputEmail" name="email"
                        readonly>
                    </div>

                    <div class="col-md-6">
                      <label for="inputPassword" class="form-label">Password</label>
                      <input type="password" class="form-control" value="<%= user.password%>" id="inputPassword"
                        name="password" placeholder="********">
                    </div>

                    <div class="col-12">
                      <label for="inputAddress" class="form-label">Address</label>
                      <input type="text" class="form-control" value="<%= user.address %>" id="inputAddress"
                        name="address" placeholder="1234 Main St">
                    </div>
                    <div class="col-md-5">
                      <label for="inputCity" class="form-label">City</label>
                      <input type="text" class="form-control" value="<%= user.city %>" id="inputCity" name="city">
                    </div>
                    <div class="col-md-5">
                      <label for="inputState" class="form-label">State</label>
                      <select id="inputState" class="form-select" name="state">
                        <option value="" selected>Choose...</option>
                        <option value="Andhra Pradesh">Andhra Pradesh</option>
                        <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                        <option value="Assam">Assam</option>
                        <option value="Bihar">Bihar</option>
                        <option value="Chhattisgarh">Chhattisgarh</option>
                        <option value="Goa">Goa</option>
                        <option value="Gujarat">Gujarat</option>
                        <option value="Haryana">Haryana</option>
                        <option value="Himachal Pradesh">Himachal Pradesh</option>
                        <option value="Jharkhand">Jharkhand</option>
                        <option value="Karnataka">Karnataka</option>
                        <option value="Kerala">Kerala</option>
                        <option value="Madhya Pradesh">Madhya Pradesh</option>
                        <option value="Maharashtra">Maharashtra</option>
                        <option value="Manipur">Manipur</option>
                        <option value="Meghalaya">Meghalaya</option>
                        <option value="Mizoram">Mizoram</option>
                        <option value="Nagaland">Nagaland</option>
                        <option value="Odisha">Odisha</option>
                        <option value="Punjab">Punjab</option>
                        <option value="Rajasthan">Rajasthan</option>
                        <option value="Sikkim">Sikkim</option>
                        <option value="Tamil Nadu">Tamil Nadu</option>
                        <option value="Telangana">Telangana</option>
                        <option value="Tripura">Tripura</option>
                        <option value="Uttar Pradesh">Uttar Pradesh</option>
                        <option value="Uttarakhand">Uttarakhand</option>
                        <option value="West Bengal">West Bengal</option>
                        <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands
                        </option>
                        <option value="Chandigarh">Chandigarh</option>
                        <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar
                          Haveli and Daman and Diu</option>
                        <option value="Delhi">Delhi</option>
                        <option value="Lakshadweep">Lakshadweep</option>
                        <option value="Puducherry">Puducherry</option>
                        <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                        <option value="Ladakh">Ladakh</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <label for="inputZip" class="form-label">Zip</label>
                      <input type="text" class="form-control" value="<%= user.zip %>" id="inputZip" name="zip">
                    </div>

                    <div class="col-md-12">
                      <label for="blood_group" class="form-label">Blood Group</label>
                      <select class="form-select" id="blood_group" name="blood_group">
                        <option value="">Select Blood Group</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                      </select>
                    </div>

                    <div class="col-md-12">
                      <label for="vaccine_id" class="form-label">COVID Vaccination Certificate-1
                        ID</label>
                      <input type="text" class="form-control" value="<%= user.vaccination_certificate_id%>"
                        id="vaccine_id" name="vaccine_id" readonly>
                    </div>

                    <div class="col-md-12">
                      <label for="vaccine_date" class="form-label">COVID Vaccination Certificate-1
                        Date</label>
                      <input type="date" class="form-control" value="<%= user.vaccination_certificate_date%>"
                        id="vaccine_date" name="vaccine_date" readonly>
                    </div>

                    <div class="col-md-12">
                      <label for="city1" class="form-label">First Vaccination City Name</label>
                      <input type="text" class="form-control" value="<%= user.first_vaccination_city%>" id="city1"
                        name="city1" readonly>
                    </div>

                    <div class="col-md-12">
                      <label for="city2" class="form-label">Second Vaccination City Name</label>
                      <input type="text" class="form-control" value="<%= user.second_vaccination_city%>" id="city2"
                        name="city2" readonly>
                    </div>
                    <br />

                    <div class="col-2">
                      <button type="button" id="updateForm" class="btn btn-primary mt-2 ">Update
                        Details</button>
                    </div>


                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

 

      <!-- Modal Vaccine Details -->
      <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-labelledby="userDetailsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="userDetailsModalLabel">Vaccine Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p><strong>Blood Group:</strong> <span id="bloodGroup" class="badge badge-danger rounded-pill">
                  <%= user.blood_group ? user.blood_group : 'NA' %>
                </span></p>
              <p><strong>Vaccine ID:</strong> <span id="vaccineId">
                  <%= user.vaccination_certificate_id ? user.vaccination_certificate_id : 'NA' %>
                </span></p>
              <p><strong>Vaccine Date:</strong> <span id="vaccineDate">
                  <%= user.vaccination_certificate_date ? user.vaccination_certificate_date : 'NA' %>
                </span></p>
              <p><strong>First Vaccination City:</strong> <span id="city1">
                  <%= user.first_vaccination_city ? user.first_vaccination_city : 'NA' %>
                </span></p>
              <p><strong>Second Vaccination City:</strong> <span id="city2">
                  <%= user.second_vaccination_city ? user.second_vaccination_city : 'NA' %>
                </span></p>
            </div>
          </div>
        </div>
      </div>

    </div>
    <%- include('partials/footer') %>
      <script src="/socket.io/socket.io.js"></script>
      <script>
        var blood_group = '<%- user.blood_group %>';
        var state = '<%= user.state %>';
        var dateStr = '<%= user.vaccination_certificate_date %>';
        var email = '<%= user.email %>';

        $(document).ready(function () {
          const socket = io();
          socket.on('userCount', function (count) {
            console.log("userCount::::", count);
            $('#userCounts').text("Users Online: " + count)
            $('#userCounts').trigger('change');
          })

          // console.log("userStae, bloodGrpp::", state, "wekmfwe");
          $('#inputState option[value="' + state + '"]').prop('selected', true);
          $('#blood_group option[value="' + blood_group + '"]').prop('selected', true);
          var date = new Date(dateStr);
          var parts = dateStr.split(' ');
          var monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          var month = monthNames.indexOf(parts[1]);
          var day = parseInt(parts[2]);
          var year = parseInt(parts[3]);
          var date = new Date(year, month, day);
          var formattedDate = date.getFullYear() + '-' +
            ('0' + (date.getMonth() + 1)).slice(-2) + '-' +
            ('0' + date.getDate()).slice(-2);

          $('#vaccine_date').val(formattedDate);

          $('#showDetailsButton').click(function (e) {
            e.preventDefault();
            $('#userDetailsModal').modal('show');
          });

          $('#updateDetails').click(function (e) {
            e.preventDefault();
            $('#editDetailsModal').modal('show');
          })

          $('#uploadBtn').on('click', function (e) {
            e.preventDefault(); 
            var input = document.getElementById('uploadImg');
            console.log(input) 
            $('#uploadedImg').attr('src', input.value)

            if (input.files && input.files[0]) {
              var reader = new FileReader();
              var imageFile = input.files[0];
              reader.onload = function (e) {
                var imageBuffer = e.target.result;
                console.log("Image Buffer:", imageBuffer);
                var imageSizeKB = imageFile.size / 1024; // Convert bytes to kilobytes
                console.log("Image Size:", imageSizeKB.toFixed(2), "KB");
                $('#uploadedImg').html(`<img src="${input} />`)
              };
              reader.readAsDataURL(input.files[0]);

              reader.onerror = function (e) {
                console.error("FileReader Error:", e.target.error);
              };
            }
          })


          $('#updateForm').on('click', function (e) {
            e.preventDefault();

            let firstName = $('#firstName').val();
            let middleName = $('#middleName').val();
            let lastName = $('#lastName').val();
            let email = $('#inputEmail').val();
            let password = $('#inputPassword').val();
            let address = $('#inputAddress').val();
            let city = $('#inputCity').val();
            let state = $('#inputState').val();
            let zip = $('#inputZip').val();
            let bloodGroup = $('#blood_group').val();
            let vaccineId = $('#vaccine_id').val();
            let vaccineDate = $('#vaccine_date').val();
            let city1 = $('#city1').val();
            let city2 = $('#city2').val();


            if (address.trim() === '') {
              swal({
                title: 'Validation Error',
                text: 'Please enter your address',
                icon: 'error',
                button: 'OK',
              });
              return;
            }

            if (city.trim() === '') {
              swal({
                title: 'Validation Error',
                text: 'Please enter your city',
                icon: 'error',
                button: 'OK',
              });
              return;
            }

            if (state.trim() === '') {
              swal({
                title: 'Validation Error',
                text: 'Please enter your state',
                icon: 'error',
                button: 'OK',
              });
              return;
            }

            if (zip.trim() === '') {
              swal({
                title: 'Validation Error',
                text: 'Please enter your ZIP code',
                icon: 'error',
                button: 'OK',
              });
              return;
            }

            if (bloodGroup.trim() === '') {
              swal({
                title: 'Validation Error',
                text: 'Please enter your blood group',
                icon: 'error',
                button: 'OK',
              });
              return;
            }

            if (vaccineId.trim() === '') {
              swal({
                title: 'Validation Error',
                text: 'Please enter your vaccine ID',
                icon: 'error',
                button: 'OK',
              });
              return;
            }

            if (city1.trim() === '') {
              swal({
                title: 'Validation Error',
                text: 'Please enter city1',
                icon: 'error',
                button: 'OK',
              });
              return;
            }

            if (city2.trim() === '') {
              swal({
                title: 'Validation Error',
                text: 'Please enter city2',
                icon: 'error',
                button: 'OK',
              });
              return;
            }

            $.ajax({
              url: '/user/update',
              method: 'POST',
              data: {
                firstName: firstName,
                middleName: middleName,
                lastName: lastName,
                email: email,
                password: password,
                address: address,
                city: city,
                state: state,
                zip: zip,
                bloodGroup: bloodGroup,
                vaccineId: vaccineId,
                vaccineDate: vaccineDate,
                city1: city1,
                city2: city2
              },
              success: function (response) {
                console.log(response);
                if (response.status) {
                  console.log("inside if", response.message);
                  swal({
                    title: response.message,
                    type: 'success',
                    icon: 'success',
                    button: 'OK',
                    timer: 2000, // Auto close after 2 seconds
                    showConfirmButton: false // Hide the "OK" button
                  }).then(() => {
                    location.reload();
                  });
                } else {
                  console.log("inside else", response.message);
                  swal({
                    title: 'Failed !!',
                    text: response.message,
                    type: 'warning',
                    icon: 'warning',
                    button: 'OK'
                  });
                }
              },
              error: function (error) {
                console.log(error.message);
                // if (!error.responseJSON.state) {
                //     swal({
                //         title: 'Failed!!',
                //         text: error.responseJSON.message,
                //         type: 'warning',
                //         icon: 'warning',
                //         button: 'OK'
                //     });
                // }
                console.error(error);
              }
            });


          })
        })
      </script>

</html>